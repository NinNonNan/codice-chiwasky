<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diario Investigativo - Formato A5</title>
<style>
  @font-face {
    font-family: 'Homemade Apple';
    src: url('/fonts/HomemadeApple.woff2') format('woff2'),
         url('/fonts/HomemadeApple.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }

  body {
    font-family: 'Homemade Apple', cursive, sans-serif;
    background: #f0f0f0;
    margin: 30px 0;
    display: flex;
    justify-content: center;
  }

  #container {
    width: 560px; /* A5 width approx */
  }

  .page {
    box-sizing: border-box;
    width: 560px;
    height: 794px; /* A5 height approx */
    background: white;
    margin-bottom: 30px;
    padding: 40px 30px;
    border: 1px solid #ccc;
    border-radius: 8px;
    overflow: hidden;

    /* Quadretti molto leggeri */
    background-image:
      linear-gradient(to right, #ddd 1px, transparent 1px),
      linear-gradient(to bottom, #ddd 1px, transparent 1px);
    background-size: 20px 20px;
  }

  .page[data-page]::before {
    content: attr(data-page);
    display: block;
    font-weight: bold;
    margin-bottom: 20px;
    font-size: 1.1em;
    color: #444;
  }

  /* Per i titoli e paragrafi */
  h1, h2 {
    margin-top: 0;
    margin-bottom: 1em;
  }

  p {
    margin-top: 0;
    margin-bottom: 1em;
    line-height: 1.5;
  }

</style>
</head>
<body>

<div id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const SAFE_HEIGHT = 794 - 40 * 2 - 30; // altezza pagina - padding verticali - margine bottom (circa)
  const container = document.getElementById('container');

  const markdownContent = `
# Diario Investigativo

## Giorno 1

Questa mattina ho esplorato i dintorni del campo base. Il terreno è fangoso e coperto da foglie umide, segno che qualcuno o qualcosa è passato di recente. Ho trovato una serie di orme che sembrano appartenere a una creatura bipede, ma con un'andatura irregolare. Potrebbe trattarsi di un ferito, o forse di qualcosa di peggio. Ho deciso di seguirle, anche se il tempo non è dalla mia parte.

La nebbia si fa sempre più fitta, e ogni albero sembra osservarmi. Continuo a scrivere per mantenere la lucidità, ma sento un costante sussurro alle mie spalle. Mi volto spesso, ma non vedo nulla. Non so se sto perdendo la ragione o se qualcosa mi segue davvero.

## Giorno 2

La notte è stata lunga e senza riposo. Ho sentito dei suoni provenire dalla boscaglia. Alcuni sembravano passi, altri voci spezzate da un'eco lontana. Quando ho acceso la torcia, il fascio di luce ha colpito qualcosa tra gli alberi: due occhi, lucidi e fissi su di me, che sono spariti non appena mi sono mosso.

Stamattina ho trovato graffi profondi sul tronco di un faggio vicino alla mia tenda. Troppo profondi per un animale comune. Ho annotato ogni dettaglio nel caso dovessi andarmene in fretta e non tornare. Questo posto ha qualcosa di malato.

## Giorno 3

Il cielo è plumbeo e l'aria è satura di elettricità. I miei strumenti registrano picchi elettromagnetici ogni volta che mi avvicino alla radura al centro della foresta. Ho provato a entrare, ma ogni volta vengo sopraffatto da un senso di nausea. È come se qualcosa cercasse di respingermi. Ho piantato dei segnali per mappare l'area. Se dovessi sparire, forse qualcuno potrà seguire le mie tracce.

Ho anche scoperto un simbolo inciso su una pietra. Non appartiene a nessuna lingua conosciuta, ma mi dà i brividi. L'ho disegnato sul retro del taccuino. Continuerò a studiarlo.

## Giorno 4

Oggi ho trovato una baracca abbandonata, nascosta tra i rovi. All'interno, una vecchia lanterna, una coperta militare e alcune foto sbiadite. In una di queste, un uomo che assomiglia incredibilmente a me, ma più giovane. Sul retro: "Non tornare mai indietro".

Ho lasciato tutto com'era e ho preso solo la foto. L'ho nascosta tra le pagine. Se mi succede qualcosa, chiunque trovi questo diario potrà vedere che non sono pazzo. Forse.

## Giorno 5

La radura mi chiama. Ho sognato il simbolo. Era vivo, si muoveva, e mi parlava. Diceva che devo tornare. Che solo io posso fermare quello che è stato risvegliato. Forse è delirio. Forse ho respirato troppe spore. Ma oggi andrò nella radura, costi quel che costi.

Se questa è la mia ultima nota, allora che serva da avvertimento. Non seguite le orme che ho lasciato. Alcuni segreti devono rimanere sepolti.
`;

  function splitIntoSentences(text) {
    text = text.trim();
    const regex = /[^.!?;]+[.!?;]?/g;
    const matches = text.match(regex);
    if (!matches) return [text];
    return matches.map(s => s.trim()).filter(s => s.length > 0);
  }

  const htmlContent = marked.parse(markdownContent);
  const tempWrapper = document.createElement('div');
  tempWrapper.innerHTML = htmlContent;
  const blocks = Array.from(tempWrapper.children);

  function createPage(pageNumber) {
    const page = document.createElement('div');
    page.className = 'page';
    page.setAttribute('data-page', `Pag. ${pageNumber}`);
    container.appendChild(page);
    return page;
  }

  function canFit(element, container) {
    container.appendChild(element);
    const fits = container.scrollHeight <= SAFE_HEIGHT;
    container.removeChild(element);
    return fits;
  }

  function addTextWithSplit(text, currentPage, pageNumber) {
    const sentences = splitIntoSentences(text);
    let tempParagraph = document.createElement('p');
    for (let i = 0; i < sentences.length; i++) {
      const sentence = sentences[i];
      tempParagraph.textContent += (tempParagraph.textContent ? ' ' : '') + sentence;

      if (!canFit(tempParagraph, currentPage)) {
        tempParagraph.textContent = tempParagraph.textContent.slice(0, -sentence.length).trim();
        if (tempParagraph.textContent.length > 0) {
          currentPage.appendChild(tempParagraph);
        }
        currentPage = createPage(++pageNumber);
        tempParagraph = document.createElement('p');
        tempParagraph.textContent = sentence;
      }

      if (i === sentences.length - 1 && tempParagraph.textContent.length > 0) {
        currentPage.appendChild(tempParagraph);
      }
    }
    return { currentPage, pageNumber };
  }

  function populatePages() {
    let pageNumber = 1;
    let currentPage = createPage(pageNumber);

    for (let block of blocks) {
      if (block.tagName === 'P') {
        const { currentPage: newPage, pageNumber: newPageNumber } = addTextWithSplit(block.textContent, currentPage, pageNumber);
        currentPage = newPage;
        pageNumber = newPageNumber;
      } else {
        let clone = block.cloneNode(true);
        if (!canFit(clone, currentPage)) {
          currentPage = createPage(++pageNumber);
        }
        currentPage.appendChild(clone);
      }
    }
  }

  container.innerHTML = '';
  populatePages();
</script>

</body>
</html>
